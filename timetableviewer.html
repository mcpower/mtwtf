<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<title>Timetables</title>
	<link href="node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
	<link href="node_modules/fullcalendar/dist/fullcalendar.min.css" rel="stylesheet">
	<style>
	#calendar {
		max-width: 800px;
		margin: 0 auto;
	}
	</style>
</head>
<body>
	<h1>Timetable <span id="timetable-index">1</span></h1>
	<div id="calendar"></div>
	<nav>
		<ul class="pager">
			<li><button class="btn btn-default" id="prev" disabled>Previous</button></li>
			<li><button class="btn btn-default" id="next">Next</button></li>
		</ul>
	</nav>
	<script>
		const ipcRenderer = require("electron").ipcRenderer;
		var jQuery = require("jquery");
		var $ = jQuery;
		var moment = require("moment");
		var fullcalendar = require("fullcalendar");
		var current_index = 0;
		var perms, unique_times, groups;
		var result = ipcRenderer.sendSync("sync-get-timetables");
		perms = result[0];
		unique_times = result[1];
		groups = result[2];
		var unique_times_events = {};

		function toMoment(day, block) {
			return moment({h: ((block >> 1) + 8), m: ((block & 1) * 30)}).day(day + 1);
		}


		function getEvent(activity, title) {
			return {
				title: title,
				start: toMoment(activity.day, activity.time),
				end: toMoment(activity.day, activity.time + activity.duration)
			};
		}

		for (var key in unique_times) {
			if (unique_times.hasOwnProperty(key)) {
				var split = key.split("|");
				split[0] = split[0].slice(0, split[0].indexOf("_"));
				var prettyName = split.join("\n");
				unique_times_events[key] = unique_times[key].map(function(big_arr) {
					return big_arr.map(function(activity) {
						return getEvent(activity, prettyName);
					});
				});
			}
		}

		function get_events(callback) {
			var events = [];
			for (var i = 0; i < groups.length; i++) {
				var key = groups[i];
				var to_concat = unique_times_events[key][perms[current_index][i]];
				events = events.concat(to_concat);
			};
			callback(events);
		}

		function decrement() {
			current_index--;
			updateDisplay();
		}

		function increment() {
			current_index++;
			updateDisplay();
		}

		function updateDisplay() {
			$("#calendar").fullCalendar("refetchEvents");
			if (current_index === 0) {
				document.getElementById("prev").disabled = true;
			} else if (current_index === perms.length - 1) {
				document.getElementById("next").disabled = true;
			} else {
				document.getElementById("prev").disabled = false;
				document.getElementById("next").disabled = false;
			}
			document.getElementById("timetable-index").innerHTML = current_index + 1;
		}


		$("#calendar").fullCalendar({
			defaultView: "agendaWeek",
			header: false,
			minTime: "08:00",
			maxTime: "20:00",
			weekends: false,
			allDaySlot: false,
			contentHeight: "auto",
			columnFormat: "ddd",
			events: function(start, end, timezone, callback) {
				get_events(callback);
			}
		});
		$("#prev").click(decrement);
		$("#next").click(increment);
		$(document).keydown(function (event) {
			switch (event.keyCode) {
			case 37:
			case 38:
				if (current_index !== 0) {
					decrement();
				}
				break;
			case 39:
			case 40:
				if (current_index !== perms.length - 1) {
					increment();
				}
				break;
			default:
				return;
			}
		});
	</script>
</body>
</html>
